
# Домашнее задание к занятию «Микросервисы: масштабирование»

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

## Задача 1: Кластеризация

Предложите решение для обеспечения развёртывания, запуска и управления приложениями.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- поддержка контейнеров;
- обеспечивать обнаружение сервисов и маршрутизацию запросов;
- обеспечивать возможность горизонтального масштабирования;
- обеспечивать возможность автоматического масштабирования;
- обеспечивать явное разделение ресурсов, доступных извне и внутри системы;
- обеспечивать возможность конфигурировать приложения с помощью переменных среды, в том числе с возможностью безопасного хранения чувствительных данных таких как пароли, ключи доступа, ключи шифрования и т. п.

Обоснуйте свой выбор.

### Ответ

#### Kubernetes + Helm + External Secrets Operator

Для управления микросервисными приложениями де-факто стандартом является Kubernetes (K8s). Это единственная платформа, которая полноценно покрывает все требования. Остальные инструменты дополняют и усиливают её.

Я предлагаю использовать следующую комбинацию:

1. Оркестратор контейнеров: Kubernetes
2. Управление конфигурацией и релизами: Helm
3. Управление секретами: External Secrets Operator + HashiCorp Vault
4. Сетевой доступ (Ingress): NGINX Ingress Controller
5. Обнаружение сервисов: Встроенный механизм Kubernetes (kube-dns/core-dns)

**Описание компонентов и их взаимодействие**
#### Kubernetes (K8s) - Ядро системы

Kubernetes — это платформа для оркестрации контейнеров, которая автоматизирует развертывание, масштабирование и управление приложениями.

- Поддержка контейнеров: Это основная функция Kubernetes. Он работает с контейнерами (Docker, containerd), упаковывая их в Pods — минимальные deployable units.

- Обнаружение сервисов и маршрутизация запросов внутри системы:
    - Service: Абстракция, которая определяет логический набор Pods и политику доступа к ним. Каждому Service присваивается стабильный IP-адрес и DNS-имя (например, auth-service.default.svc.cluster.local).
    - kube-dns / CoreDNS: Встроенный DNS-сервер, который автоматически регистрирует все Services. Микросервисы могут общаться друг с другом по этим DNS-именам, не зная реальных IP-адресов Pods.

- Горизонтальное масштабирование (Horizontal Pod Autoscaler - HPA):
    - HPA автоматически увеличивает или уменьшает количество реплик Pod (например, с 3 до 10) на основе наблюдаемой метрики CPU, памяти или кастомной метрики (например, количества сообщений в очереди).

- Автоматическое масштабирование:
    - HPA (как описано выше) для масштабирования приложений.
    - Cluster Autoscaler: Автоматически масштабирует сам кластер Kubernetes, добавляя или удаляя рабочие ноды в пуле, когда Pod'ам не хватает ресурсов для запуска или ноды простаивают.

- Разделение ресурсов:
    - Namespaces: Логическое разделение кластера (например, dev, stage, production). Позволяют изолировать команды и среды.
    - Network Policies: Определяют правила входящего и исходящего трафика для Pods. Явно разрешают или запрещают общение между компонентами.

#### Helm - Управление конфигурацией
Helm — это менеджер пакетов для Kubernetes. Он позволяет управлять приложениями через концепцию Charts — предварительно сконфигурированных наборов Kubernetes-ресурсов.

- Конфигурирование приложений: В Helm-чартах используются values.yaml файлы и шаблонизация. Вы можете определять переменные (например, replicaCount, image.tag, env variables), которые подставляются в шаблоны манифестов при деплое.

- Упрощение деплоя: Сложное приложение из десятков манифестов деплоится одной командой: helm install my-app ./my-chart -f values-prod.yaml.

#### External Secrets Operator + HashiCorp Vault - Безопасное хранение секретов
- HashiCorp Vault: Профессиональное решение для хранения секретов, шифрования и управления доступом. Хранит пароли, ключи API, TLS-сертификаты.

- External Secrets Operator (ESO): Оператор для Kubernetes, который автоматически синхронизирует секреты из внешних источников (например, Vault) в native Kubernetes Secrets.
    - Принцип работы: Вы создаете манифест ExternalSecret, который описывает, какой секрет из Vault нужно достать. ESO читает этот манифест, обращается к Vault, получает данные и создает в вашем namespace обычный Kubernetes Secret. Приложение же работает просто с стандартным Kubernetes Secret, как будто он был создан вручную.

#### NGINX Ingress Controller - Доступ извне
- Явное разделение доступа: Внутренние сервисы общаются через ClusterIP Services. Доступ снаружи обеспечивается через Ingress.

- Ingress: API-объект в Kubernetes, который управляет внешним доступом к сервисам (обычно через HTTP/HTTPS). Он определяет правила маршрутизации трафика.

- Ingress Controller: Реализация правил Ingress. NGINX Ingress Controller — это самый популярный контроллер, который разворачивается как Pod в кластере и обеспечивает терминацию TLS, балансировку нагрузки и роутинг на основе хоста/path.

**Соответствие требованиям**
Требование	|	Реализация в предложенном стеке
-|-
Поддержка контейнеров	|	✅ Базовая функция Kubernetes.
Обнаружение сервисов и маршрутизация	|	✅ Внутри: kube-dns + Service. Снаружи: Ingress + Ingress Controller.
Возможность горизонтального масштабирования	|	✅ kubectl scale deployment (ручное) или HPA (автоматическое).
Возможность автоматического масштабирования	|	✅ HPA (масштабирование приложений) + Cluster Autoscaler (масштабирование нод).
Явное разделение ресурсов	|	✅ Network Policies (сетеввая изоляция) + Namespaces (логическая изоляция) + Ingress (внешний доступ).
Конфигурирование через переменные среды	|	✅ ConfigMap и Secret — нативные объекты K8s для конфигурации.
Безопасное хранение чувствительных данных	|	✅ HashiCorp Vault (источник истины) + External Secrets Operator (синхронизация в K8s Secrets).

